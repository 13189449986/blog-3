## deploy strategies

重新理解一下部署策略 rolling release (or rolling update )   
結果查來查去，這些名詞都沒有標準的定義與實作方式。看來是都是偏向一種概念給拿捏...  

 - 部分滾動更新，半滾動更新
 - 完全滾動更新
 - 偽滾動更新
 - 真滾動更新
 - 選擇性滾動更新
 - 迴圈滾動更新

反而都是看到 k8s 的文章討論新的(k8s)部署方式跟舊的(k8s)方式比較
Kubernetes `Deployment` vs `ReplicationController rolling update`

k8s 後面有空在看，先 focue 到 deploy 策略。要比較的應該是這樣的面向
 - Rolling updates
 - Blue-green deployments
 - Canary releases

### Rolling updates (滾動)
滾動發布，一般是取出一個或者多個服務器停止服務，執行更新，並重新將其投入使用。周而覆始，直到集群中所有的實例都更新成新版本。這種部署方式相對於藍綠部署，更加節約資源——它不需要運行兩個集群、兩倍的實例數。我們可以部分部署，例如每次只取出集群的20%進行升級。

這種方式也有很多缺點，例如：  
  1. 沒有一個確定OK的環境。使用藍綠部署，我們能夠清晰地知道老版本是OK的，而使用滾動發布，我們無法確定。
  2. 修改了現有的環境。
  3. 如果需要回滾，很困難。舉個例子，在某一次發布中，我們需要更新100個實例，每次更新10個實例，每次部署需要5分鐘。當滾動發布到第80個實例時，發現了問題，需要回滾。此時，脾氣不好的程序猿很可能想掀桌子，因為回滾是一個痛苦，並且漫長的過程。
  4. 有的時候，我們還可能對系統進行動態伸縮，如果部署期間，系統自動擴容/縮容了，我們還需判斷到底哪個節點使用的是哪個代碼。盡管有一些自動化的運維工具，但是依然令人心驚膽戰。

並不是說滾動發布不好，滾動發布也有它非常合適的場景。  
滾動發布：按批次停止老版本實例，啟動新版本實例。


#### Blue-green deployments (藍綠)
藍綠部署的目的是減少發布時的中斷時間、能夠快速撤回發布。藍綠部署無需停機，並且風險較小。

藍綠部署中，一共有兩套系統：
 - 一套是正在提供服務系統，標記為「綠色」
 - 另一套是準備發布的系統，標記為「藍色」。(不對外提供服務)
 
兩套系統都是功能完善的，並且正在運行的系統，只是系統版本和對外服務情況不同。一共有兩套系統在運行，正在對外提供服務的老系統是綠色系統，新部署的系統是藍色系統

藍色系統不對外提供服務，用來做啥？
用來做發布前測試，測試過程中發現任何問題，可以直接在藍色系統上修改，不幹擾用戶正在使用的系統。（註意，兩套系統沒有耦合的時候才能百分百保證不幹擾）

藍色系統經過反覆的測試、修改、驗證，確定達到上線標準之後，直接將用戶切換到藍色系統

切換後的一段時間內，依舊是藍綠兩套系統並存，但是用戶訪問的已經是藍色系統。這段時間內觀察藍色系統（新系統）工作狀態，如果出現問題，直接切換回綠色系統。

當確信對外提供服務的藍色系統工作正常，不對外提供服務的綠色系統已經不再需要的時候，藍色系統正式成為對外提供服務系統，成為新的綠色系統。 原先的綠色系統可以銷毀，將資源釋放出來，用於部署下一個藍色系統。

從過程不難發現，在部署的過程中，系統始終在線。並且，**新版本上線的過程中，並沒有修改老版本的任何內容，在部署期間，老版本的狀態不受影響。這樣風險很小，並且，只要老版本的資源不被刪除，理論上，我們可以在任何時間回滾到老版本。**

藍綠部署只是上線策略中的一種，它不是可以應對所有情況的萬能方案。**藍綠部署能夠簡單快捷實施的前提假設是目標系統是非常內聚的，如果目標系統相當覆雜，那麽如何切換、兩套系統的數據是否需要以及如何同步等**，都需要仔細考慮。  
藍綠部署：不停止老版本，額外搞一套新版本，等測試發現新版本OK後，刪除老版本。

#### Canary releases (金絲雀)
金絲雀發布（Canary）也是一種發布策略，和國內常說的灰度發布是同一類策略。

 - 藍綠部署　是準備兩套系統，在兩套系統之間進行切換
 - 金絲雀策略是只有一套系統，逐漸替換這套系統。

譬如說，目標系統是一組無狀態的Web服務器，但是數量非常多，假設有**一萬台。這時候，藍綠部署就不能用了，因為你不可能申請一萬台服務器專門用來部署藍色系統（在藍綠部署的定義中，藍色的系統要能夠承接所有訪問）**。

可以想到的一個方法是：只準備幾台服務器，在上面部署新版本的系統並測試驗證。測試通過之後，擔心出現意外，還不敢立即更新所有的服務器。**先將線上的一萬台服務器中的10台更新為最新的系統，然後觀察驗證。確認沒有異常之後，再將剩余的所有服務器更新。**這個方法就是金絲雀發布。

實際操作中還可以做更多控制，譬如說，**給最初更新的10台服務器設置較低的權重、控制發送給這10台服務器的請求數，然後逐漸提高權重、增加請求數。**這個控制叫做**流量切分**，既可以用於金絲雀發布，也可以用於後面的**A/B測試**。

藍綠部署和金絲雀發布是兩種發布策略，都不是萬能的。有時候兩者都可以使用，有時候只能用其中一種。

我們來看一下金絲雀部署的步驟：
 1. 準備好部署各個階段的工件，包括：構建工件，測試腳本，配置文件和部署清單文件。
 2. 從負載均衡列表中移除掉"金絲雀"服務器。
 3. 升級"金絲雀"應用（排掉原有流量並進行部署）。
 4. 對應用進行自動化測試。
 5. 將"金絲雀"服務器重新添加到負載均衡列表中（連通性和健康檢查）。
 6. 如果"金絲雀"在線使用測試成功，升級剩余的其他服務器。（否則就回滾）

灰度發布中，常常按照用戶設置路由權重，例如90%的用戶維持使用老版本，10%的用戶嘗鮮新版本。不同版本應用共存，經常與A/B測試一起使用，用於測試選擇多種方案。  

灰度發布比較典型的例子，有些系統畫面會讓你點擊「進入新版本」，我們就成了金絲雀。

金絲雀部署/灰度發布：不停止老版本，額外搞一套新版本，常常按照用戶設置路由權重，例如90%的用戶維持使用老版本，10%的用戶嘗鮮新版本。不同版本應用共存，經常與A/B測試一起使用，用於測試選擇多種方案

### A/B測試
首先需要明確的是，A/B測試和藍綠部署以及金絲雀，完全是兩回事。藍綠部署和金絲雀是發布策略，目標是確保新上線的系統穩定，關註的是新系統的BUG、隱患。  

**A/B測試是效果測試**，同一時間有多個版本的服務對外服務，這些服務都是經過足夠測試，達到了上線標準的服務，有差異但是沒有新舊之分（它們上線時可能采用了藍綠部署的方式）。  

> A/B測試關註的是不同版本的服務的實際效果，譬如說轉化率、訂單情況等。

A/B測試時，線上同時運行多個版本的服務，這些服務通常會有一些體驗上的差異，譬如說頁面樣式、顏色、操作流程不同。相關人員通過分析各個版本服務的實際效果，選出效果最好的版本。  

在A/B測試中，**需要能夠控制流量的分配**，譬如說，
 - 為A版本分配10%的流量
 - 為B版本分配10%的流量
 - 為C版本分配80%的流量。









